extends ../../layouts/default.pug
include ../../mixins/filterStatus.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/formChangeMulti.pug
include ../../mixins/alert.pug
include ../../mixins/sort.pug

block content
  if role.permission.includes("products_view")
    +alert-success("5000")
    h1.text-primary.mb-4= title

    .card.mb-4.shadow
      .card-header.bg-light.font-weight-bold Bộ lọc sản phẩm
      .card-body
        .row.align-items-end
          .col-md-6
            +filter-status(filterStatus)
          .col-md-6
            +search(keyword)

    if products.length > 0
      .card.shadow-sm
        .card-header.bg-light.font-weight-bold.d-flex.justify-content-between.align-items-center
          span Danh sách sản phẩm
          if role.permission.includes("products_create")
            a(href=`${prefixAdmin}/products/create`, class="btn btn-success btn-sm") 
              i.fas.fa-plus-circle.me-1
              | Thêm mới

        .card-body
          .row.mb-3
            .col-md-4
              +form-change-multi(`${prefixAdmin}/products/change-multi?_method=PATCH`)
            .col-md-4
              +sortBox

          table.table.table-hover.table-bordered.align-middle.text-center.table-sm
            thead.table-light
              tr
                th 
                  input(type="checkbox", name="checkall")
                th #
                th Tên sản phẩm
                th Giá
                th Mô tả
                th Ảnh
                th Vị trí
                th Hành động
                th Trạng thái
                th Tạo bởi
                th Cập nhật bởi
            tbody
              each product, index in products
                tr
                  td 
                    input(type="checkbox", name="id", value=product.id)
                  td= index + 1
                  td.text-start= product.title
                  td.text-nowrap.text-success= product.price
                  td.text-start!= product.description
                  td
                    img(src=product.thumbnail, alt=product.title, style="width: 80px; height: auto;", class="img-thumbnail")
                  td
                    input.form-control.form-control-sm(
                      type="number", 
                      value=product.position, 
                      style="width: 70px; margin: auto", 
                      min="1", 
                      name="position"
                    )
                  td
                    if role.permission.includes("products_view")
                      a.btn.btn-outline-secondary.btn-sm.me-1(
                        href=`${prefixAdmin}/products/detail/${product.id}`
                      ) 
                        i.fas.fa-eye
                        |  Xem
                    if role.permission.includes("products_edit")
                      a.btn.btn-outline-warning.btn-sm.me-1(
                        href=`${prefixAdmin}/products/edit/${product.id}`
                      ) 
                        i.fas.fa-edit
                        |  Sửa
                    if role.permission.includes("products_delete")
                      button.btn.btn-outline-danger.btn-sm(
                        button-Delete,
                        data-id=product.id
                      ) 
                        i.fas.fa-trash
                        |  Xóa
                  td
                    if role.permission.includes("products_edit")
                      a(
                        href="javascript:;",
                        class=product.status === 'active' ? "badge bg-success" : "badge bg-secondary",
                        button-change-status,
                        data-status=product.status,
                        data-id=product.id
                      )= product.status === 'active' ? 'Đang hoạt động' : 'Không hoạt động'
                    else
                      span.badge.bg-secondary Không có quyền
                  td.text-start
                    if product.createdBy && product.createdBy.account_id && product.createdBy.createAt
                      p.mb-0.fw-bold= product.accFullname || 'Người dùng không xác định'
                      small.text-muted
                        | Tạo: #{moment(product.createdBy.createAt).calendar()} 
                        | (#{moment(product.createdBy.createAt).fromNow()})
                    else
                      small.text-muted Không có thông tin
                  td.text-start
                    - const lastUpdated = product.updatedBy && product.updatedBy.length > 0 ? product.updatedBy[product.updatedBy.length - 1] : null
                    if lastUpdated && lastUpdated.account_id && lastUpdated.updatedAt
                      p.mb-0.fw-bold= product.accountFullName || 'Người dùng không xác định'
                      small.text-muted
                        | Cập nhật: #{moment(lastUpdated.updatedAt).calendar()} 
                        | (#{moment(lastUpdated.updatedAt).fromNow()})
                    else
                      small.text-muted Không có thông tin
    else
      .alert.alert-info.text-center.mt-4 Không có sản phẩm nào.

    +pagination(pagination)

    form#form-change-status(
      action="", 
      method="POST",
      data-path=`${prefixAdmin}/products/change-status`
    )

    form#form-delete-item(
      action="", 
      method="POST",
      data-path=`${prefixAdmin}/products/deleteItem`
    )

    script(src="/admin/js/product.js")
